import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import WebAppInfo, LabeledPrice, PreCheckoutQuery

# 1. –¢–í–û–ô –¢–û–ö–ï–ù (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–≤—å —Å–≤–æ–π!)
API_TOKEN = '–¢–í–û–ô_–¢–û–ö–ï–ù_–¢–£–¢'

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# --- –®–ê–ì 3: –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• –ò–ó MINI APP ---
@dp.message(lambda message: message.web_app_data)
async def handle_web_app_data(message: types.Message):
    # –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç:
    if message.web_app_data.data == "action_buy_stars":
        # –ë–æ—Ç –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç –Ω–∞ 10 –∑–≤–µ–∑–¥
        await bot.send_invoice(
            chat_id=message.chat.id,
            title="–ó–∞—Ö–≤–∞—Ç –ú–æ—Å–∫–≤—ã",
            description="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–≤–∏–¥–∏—Ç –≤—Å—è –ú–æ—Å–∫–≤–∞!",
            payload="capture_payload",
            currency="XTR", # –ö–æ–¥ –≤–∞–ª—é—Ç—ã Telegram Stars
            prices=[LabeledPrice(label="–ó–∞—Ö–≤–∞—Ç", amount=10)],
            provider_token="" # –î–ª—è –∑–≤–µ–∑–¥ –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç–æ
        )

# --- –ü–†–û–í–ï–†–ö–ê –ü–õ–ê–¢–ï–ñ–ê (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) ---
@dp.pre_checkout_query()
async def process_pre_checkout_query(pre_checkout_query: PreCheckoutQuery):
    await bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)

# --- –ü–û–°–õ–ï –û–ü–õ–ê–¢–´ ---
@dp.successful_payment()
async def process_successful_payment(message: types.Message):
    await message.answer("üéâ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞! –í—ã –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –ú–æ—Å–∫–≤—ã!")

# –ö–æ–º–∞–Ω–¥–∞ /start
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    markup = types.ReplyKeyboardMarkup(
        keyboard=[
            [types.KeyboardButton(
                text="üöÄ –û–¢–ö–†–´–¢–¨ MOSCOW SPOTLIGHT", 
                web_app=WebAppInfo(url="https://the934og-netizen.github.io/moscow-spotlight/")
            )]
        ],
        resize_keyboard=True
    )
    await message.answer(f"–ü—Ä–∏–≤–µ—Ç, {message.from_user.full_name}! –ì–æ—Ç–æ–≤ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —ç—Ñ–∏—Ä?", reply_markup=markup)

async def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ó–≤–µ–∑–¥—ã...")
    await dp.start_polling(bot)

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("–ë–æ—Ç –≤—ã–∫–ª—é—á–µ–Ω")
